<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4-Channel Relay Dashboard</title>
<style>
  /* YOUR STYLES ARE PERFECT - NO CHANGES */
  body { font-family: Arial, sans-serif; text-align:center; background:#f4f4f9; color:#333; }
  h2 { margin-top: 20px; }
  .relay-container { margin: 15px auto; }
  button { width: 120px; height: 50px; font-size:18px; margin:5px; border:none; border-radius:10px; cursor:pointer; color:white; }
  button:active { transform:translateY(2px); }
  .on { background: limegreen; }
  .off { background: tomato; }
  .disabled { background: gray; cursor: not-allowed; }
  #espStatus, #mqttStatus { font-weight:bold; font-size:18px; margin-top:10px; }
  .online { color: limegreen; font-weight: bold; }
  .offline { color: red; font-weight: bold; }
</style>
</head>
<body>

<h2>4-Channel Relay Control</h2>

<!-- RELAY 1-4 CONTAINERS (PERFECT) -->
<div class="relay-container">
  <p>Relay 1 Status: <b id="relay1Status">--</b></p>
  <button id="relay1On" class="off" onclick="sendCommand(1,'ON')">ON</button>
  <button id="relay1Off" class="on" onclick="sendCommand(1,'OFF')">OFF</button>
</div>
<!-- Repeat for relay2,3,4 (your code perfect) -->

<hr>

<p>ESP Status: <span id="espStatus" class="offline">OFFLINE</span></p>
<p>ESP IP: <b id="espIP">--</b></p>
<p>ESP Uptime: <b id="espUptime">00:00:00</b></p>
<!-- FIXED: Remove reset button (matches your ESP code) -->
<!-- <button id="resetBtn" onclick="resetESP()">RESET ESP</button> -->

<p id="mqttStatus">MQTT: Disconnected</p>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const broker = 'wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt';
  const options = {
    username: 'tohits', password: 'toh123@TOH',
    reconnectPeriod: 1000, clean: true, connectTimeout: 4000
  };
  const client = mqtt.connect(broker, options);

  let relayStatus = [null,"OFF","OFF","OFF","OFF"];

  function updateRelayUI(ch){
    const statusEl = document.getElementById(`relay${ch}Status`);
    const onBtn = document.getElementById(`relay${ch}On`);
    const offBtn = document.getElementById(`relay${ch}Off`);

    statusEl.innerText = relayStatus[ch] || "--";

    if(relayStatus[ch]==="ON"){
      onBtn.className = "on";    // ON button green
      offBtn.className = "off";  // OFF button red
    } else {
      onBtn.className = "off";   // ON button red
      offBtn.className = "on";   // OFF button green
    }
  }

  // FIXED: Direct ON/OFF (no active-low swap needed)
  function sendCommand(ch, cmd){
    if(client.connected){
      client.publish(`relay${ch}/control`, cmd);  // Send exact "ON"/"OFF"
      alert(`Relay ${ch} ${cmd} sent!`);
    } else {
      alert("MQTT not connected!");
    }
  }

  // ---------- MQTT EVENTS ----------
  client.on('connect', () => {
    document.getElementById("mqttStatus").innerText = "MQTT: Connected âœ…";
    document.getElementById("mqttStatus").style.color = "limegreen";
    client.subscribe([
      'relay1/status','relay2/status','relay3/status','relay4/status',
      'esp/+/status',    // FIXED: Matches ESP code esp/1234/status
      'esp/+/ip',
      'esp/+/uptime'
    ]);
  });

  client.on('message', (topic,message)=>{
    const msg = message.toString();

    // Relay status updates
    if(topic.match(/^relay[1-4]\/status$/)){
      const ch = parseInt(topic.charAt(5));
      relayStatus[ch] = msg;
      updateRelayUI(ch);
    }

    // FIXED: Handle esp/1234/status format
    if(topic.match(/^esp\/\d+\/status$/)){
      const espStatus = document.getElementById('espStatus');
      espStatus.innerText = msg;
      espStatus.className = (msg==="ONLINE") ? "online" : "offline";
    }

    if(topic.match(/^esp\/\d+\/ip$/)){
      document.getElementById('espIP').innerText = msg;
    }

    if(topic.match(/^esp\/\d+\/uptime$/)){
      document.getElementById('espUptime').innerText = msg;
    }
  });

  // Rest of your offline/reconnect handlers perfect...
</script>
</body>
</html>
