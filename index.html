<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4-Channel Relay Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; background:#f4f4f9; color:#333; }
  h2 { margin-top: 20px; }
  .relay-container { margin: 15px auto; }
  button { width: 120px; height: 50px; font-size:18px; margin:5px; border:none; border-radius:10px; cursor:pointer; color:white; }
  button:active { transform:translateY(2px); }
  .on { background: limegreen; }
  .off { background: tomato; }
  .booting { background: orange; color: white; } /* NEW: Boot state */

  #espStatus, #mqttStatus { font-weight:bold; font-size:18px; margin-top:10px; }
  .online { color: limegreen; font-weight: bold; }
  .offline { color: red; font-weight: bold; }
</style>
</head>
<body>

<h2>4-Channel Relay Control</h2>

<!-- ✅ BOOT STATE: Show "BOOTING" during ESP startup -->
<div class="relay-container">
  <p>Relay 1: <b id="relay1Status">BOOTING</b></p>
  <button id="relay1On" class="booting" onclick="sendCommand(1,'ON')">ON</button>
  <button id="relay1Off" class="booting" onclick="sendCommand(1,'OFF')">OFF</button>
</div>

<div class="relay-container">
  <p>Relay 2: <b id="relay2Status">BOOTING</b></p>
  <button id="relay2On" class="booting" onclick="sendCommand(2,'ON')">ON</button>
  <button id="relay2Off" class="booting" onclick="sendCommand(2,'OFF')">OFF</button>
</div>

<div class="relay-container">
  <p>Relay 3: <b id="relay3Status">BOOTING</b></p>
  <button id="relay3On" class="booting" onclick="sendCommand(3,'ON')">ON</button>
  <button id="relay3Off" class="booting" onclick="sendCommand(3,'OFF')">OFF</button>
</div>

<div class="relay-container">
  <p>Relay 4: <b id="relay4Status">BOOTING</b></p>
  <button id="relay4On" class="booting" onclick="sendCommand(4,'ON')">ON</button>
  <button id="relay4Off" class="booting" onclick="sendCommand(4,'OFF')">OFF</button>
</div>

<hr>

<p>ESP Status: <span id="espStatus" class="offline">BOOTING...</span></p>
<p>ESP IP: <b id="espIP">--</b></p>
<p>ESP Uptime: <b id="espUptime">00:00:00</b></p>

<p id="mqttStatus">MQTT: Disconnected</p>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const broker = 'wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt';
  const client = mqtt.connect(broker, {
    username: 'tohits', password: 'toh123@TOH',
    reconnectPeriod: 1000, clean: true, connectTimeout: 4000
  });

  let relayStatus = [null,"BOOTING","BOOTING","BOOTING","BOOTING"];
  let espBooted = false;

  function updateRelayUI(ch){
    const statusEl = document.getElementById(`relay${ch}Status`);
    const onBtn = document.getElementById(`relay${ch}On`);
    const offBtn = document.getElementById(`relay${ch}Off`);

    // ✅ SHOW REAL STATUS WHEN ESP REPORTS
    if(relayStatus[ch] === "ON"){
      statusEl.innerText = "ON";
      onBtn.className = "on";
      offBtn.className = "off";
    } else if(relayStatus[ch] === "OFF"){
      statusEl.innerText = "OFF";
      onBtn.className = "off";
      offBtn.className = "on";
    } else {
      statusEl.innerText = "BOOTING";  // Until ESP reports
      onBtn.className = "booting";
      offBtn.className = "booting";
    }
  }

  function sendCommand(ch, cmd){
    if(client.connected){
      client.publish(`relay${ch}/control`, cmd);
    } else {
      alert("MQTT not connected!");
    }
  }

  // ---------- MQTT EVENTS ----------
  client.on('connect', () => {
    document.getElementById("mqttStatus").innerText = "MQTT: Connected ✅";
    document.getElementById("mqttStatus").style.color = "limegreen";
    client.subscribe([
      'relay1/status','relay2/status','relay3/status','relay4/status',
      'esp/+/status','esp/+/ip','esp/+/uptime',  // OR devices/+/status for MAC
      'devices/+/status','devices/+/ip','devices/+/uptime'
    ]);
  });

  client.on('message', (topic,message)=>{
    const msg = message.toString();

    // ✅ RELAY STATUS - Updates when ESP publishes after boot
    if(topic.match(/^relay[1-4]\/status$/)){
      const ch = parseInt(topic.charAt(5));
      relayStatus[ch] = msg;
      updateRelayUI(ch);
    }

    // ✅ ESP STATUS - Marks boot complete
    if(topic.match(/^(esp|devices)\/[0-9a-f\d]+\/status$/)){
      const espStatusEl = document.getElementById('espStatus');
      espStatusEl.innerText = msg;
      espStatusEl.className = (msg==="ONLINE") ? "online" : "offline";
      espBooted = (msg === "ONLINE");
    }

    // IP & Uptime
    if(topic.match(/^(esp|devices)\/[0-9a-f\d]+\/(ip|uptime)$/)){
      if(topic.match(/ip$/)) document.getElementById('espIP').innerText = msg;
      if(topic.match(/uptime$/)) document.getElementById('espUptime').innerText = msg;
    }
  });
</script>
</body>
</html>
