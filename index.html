<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4-Channel Relay Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; background:#f4f4f9; color:#333; }
  h2 { margin-top: 20px; }
  .relay-container { margin: 15px auto; }
  button { width: 120px; height: 50px; font-size:18px; margin:5px; border:none; border-radius:10px; cursor:pointer; color:white; }
  button:active { transform:translateY(2px); }
  .on { background: limegreen; }
  .off { background: tomato; }
  .booting { background: orange; }

  #espStatus, #mqttStatus { font-weight:bold; font-size:18px; margin-top:10px; }
  .online { color: limegreen; font-weight: bold; }
  .offline { color: red; font-weight: bold; }
</style>
</head>
<body>

<h2>4-Channel Relay Control (Active LOW)</h2>

<!-- ‚úÖ PHYSICAL STATE: ALL RELAYS ON at boot -->
<div class="relay-container">
  <p>Relay 1: <b id="relay1Status">ON</b></p>
  <button id="relay1On" class="on" onclick="sendCommand(1,'OFF')">ON üîí</button>   <!-- ‚úÖ Already ON -->
  <button id="relay1Off" class="off" onclick="sendCommand(1,'ON')">OFF ‚û°Ô∏è</button>  <!-- ‚úÖ Click to turn OFF -->
</div>

<div class="relay-container">
  <p>Relay 2: <b id="relay2Status">ON</b></p>
  <button id="relay2On" class="on" onclick="sendCommand(2,'OFF')">ON üîí</button>
  <button id="relay2Off" class="off" onclick="sendCommand(2,'ON')">OFF ‚û°Ô∏è</button>
</div>

<div class="relay-container">
  <p>Relay 3: <b id="relay3Status">ON</b></p>
  <button id="relay3On" class="on" onclick="sendCommand(3,'OFF')">ON üîí</button>
  <button id="relay3Off" class="off" onclick="sendCommand(3,'ON')">OFF ‚û°Ô∏è</button>
</div>

<div class="relay-container">
  <p>Relay 4: <b id="relay4Status">ON</b></p>
  <button id="relay4On" class="on" onclick="sendCommand(4,'OFF')">ON üîí</button>
  <button id="relay4Off" class="off" onclick="sendCommand(4,'ON')">OFF ‚û°Ô∏è</button>
</div>

<hr>
<p>ESP Status: <span id="espStatus" class="offline">OFFLINE</span></p>
<p>ESP IP: <b id="espIP">--</b></p>
<p>ESP Uptime: <b id="espUptime">00:00:00</b></p>
<p id="mqttStatus">MQTT: Disconnected</p>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const broker = 'wss://93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud:8884/mqtt';
  const client = mqtt.connect(broker, {
    username: 'tohits', password: 'toh123@TOH',
    reconnectPeriod: 1000, clean: true, connectTimeout: 4000
  });

  // ‚úÖ INITIAL STATE: ALL RELAYS PHYSICALLY ON
  let relayStatus = [null,"ON","ON","ON","ON"];

  function updateRelayUI(ch){
    const statusEl = document.getElementById(`relay${ch}Status`);
    const onBtn = document.getElementById(`relay${ch}On`);
    const offBtn = document.getElementById(`relay${ch}Off`);

    statusEl.innerText = relayStatus[ch];
    
    if(relayStatus[ch] === "ON"){
      // ‚úÖ RELAY PHYSICALLY ON (pin LOW)
      onBtn.className = "on";   // ON button GREEN (already active)
      offBtn.className = "off"; // OFF button RED (ready to activate)
      onBtn.innerText = "ON üîí";  // Locked/indicates already ON
    } else {
      // ‚úÖ RELAY PHYSICALLY OFF (pin HIGH)  
      onBtn.className = "off";  // ON button RED (ready to activate)
      offBtn.className = "on";  // OFF button GREEN (already active)
      onBtn.innerText = "ON ‚û°Ô∏è"; // Ready to turn ON
      offBtn.innerText = "OFF üîí";
    }
  }

  function sendCommand(ch, cmd){
    if(client.connected){
      client.publish(`relay${ch}/control`, cmd);
      console.log(`Sent relay${ch}: ${cmd}`);
    } else {
      alert("MQTT not connected!");
    }
  }

  // ‚úÖ Initialize UI - Perfect match with physical relays
  window.onload = function() {
    for(let ch=1; ch<=4; ch++) {
      updateRelayUI(ch);
    }
  };

  client.on('connect', () => {
    document.getElementById("mqttStatus").innerText = "MQTT: Connected ‚úÖ";
    document.getElementById("mqttStatus").style.color = "limegreen";
    client.subscribe([
      'relay1/status','relay2/status','relay3/status','relay4/status',
      'esp/+/status','esp/+/ip','esp/+/uptime',
      'devices/+/status','devices/+/ip','devices/+/uptime'
    ]);
  });

  client.on('message', (topic,message)=>{
    const msg = message.toString();

    // ‚úÖ ESP RELAY STATUS UPDATES
    if(topic.match(/^relay[1-4]\/status$/)){
      const ch = parseInt(topic.charAt(5));
      relayStatus[ch] = msg;
      updateRelayUI(ch);
      console.log(`Relay ${ch}: ${msg}`);
    }

    // ESP status
    if(topic.match(/^(esp|devices)\/[0-9a-f\d]+\/status$/)){
      const espStatusEl = document.getElementById('espStatus');
      espStatusEl.innerText = msg;
      espStatusEl.className = (msg==="ONLINE") ? "online" : "offline";
    }

    if(topic.match(/^(esp|devices)\/[0-9a-f\d]+\/ip$/)){
      document.getElementById('espIP').innerText = msg;
    }
    if(topic.match(/^(esp|devices)\/[0-9a-f\d]+\/uptime$/)){
      document.getElementById('espUptime').innerText = msg;
    }
  });
</script>
</body>
</html>
